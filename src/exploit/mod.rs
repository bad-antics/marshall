//! Dr. Marshall Exploit Assistant
//! 
//! Advanced exploit research, generation, and deployment system.
//! Features obscure/unknown exploits and custom payload generation.

pub mod database;
pub mod payloads;
pub mod builders;
pub mod shells;
pub mod rootkits;

use serde::{Deserialize, Serialize};
use std::collections::HashMap;
use chrono::{DateTime, Utc};

/// Exploit severity levels
#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]
pub enum Severity {
    Critical,
    High,
    Medium,
    Low,
    Informational,
}

/// Exploit category classification
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum ExploitCategory {
    // Memory corruption
    BufferOverflow,
    HeapOverflow,
    UseAfterFree,
    TypeConfusion,
    IntegerOverflow,
    
    // Web
    SqlInjection,
    XSS,
    SSRF,
    XXE,
    SSTI,
    
    // Logic
    AuthBypass,
    RaceCondition,
    IDOR,
    PrivilegeEscalation,
    
    // Binary
    ROP,
    JOP,
    SROP,
    RetToLibc,
    
    // Advanced
    Kernel,
    Hypervisor,
    Firmware,
    Hardware,
    SideChannel,
    
    // Stealth
    Rootkit,
    Bootkit,
    Fileless,
    LivingOffTheLand,
}

/// Main exploit entry
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Exploit {
    pub id: String,
    pub name: String,
    pub aliases: Vec<String>,
    pub description: String,
    pub category: ExploitCategory,
    pub severity: Severity,
    pub cve: Option<String>,
    pub discovered_date: Option<DateTime<Utc>>,
    pub affected_systems: Vec<String>,
    pub prerequisites: Vec<String>,
    pub payload: Option<String>,
    pub poc_code: Option<String>,
    pub mitigations: Vec<String>,
    pub references: Vec<String>,
    pub obscurity_level: u8, // 1-10, 10 being most obscure
    pub detection_difficulty: u8, // 1-10
    pub reliability: u8, // 1-10
}

/// Dr. Marshall Exploit Engine
pub struct ExploitEngine {
    pub database: database::ExploitDatabase,
    pub payload_generator: payloads::PayloadGenerator,
    pub shell_builder: shells::ShellBuilder,
    pub rootkit_builder: rootkits::RootkitBuilder,
}

impl ExploitEngine {
    pub fn new() -> Self {
        Self {
            database: database::ExploitDatabase::new(),
            payload_generator: payloads::PayloadGenerator::new(),
            shell_builder: shells::ShellBuilder::new(),
            rootkit_builder: rootkits::RootkitBuilder::new(),
        }
    }
    
    /// Search for exploits by various criteria
    pub fn search(&self, query: &str) -> Vec<&Exploit> {
        self.database.search(query)
    }
    
    /// Get obscure exploits not widely known
    pub fn get_obscure_exploits(&self, min_obscurity: u8) -> Vec<&Exploit> {
        self.database.exploits.values()
            .filter(|e| e.obscurity_level >= min_obscurity)
            .collect()
    }
    
    /// Generate custom payload
    pub fn generate_payload(&self, config: payloads::PayloadConfig) -> Result<Vec<u8>, String> {
        self.payload_generator.generate(config)
    }
    
    /// Build custom shell
    pub fn build_shell(&self, config: shells::ShellConfig) -> Result<Vec<u8>, String> {
        self.shell_builder.build(config)
    }
    
    /// Build custom rootkit
    pub fn build_rootkit(&self, config: rootkits::RootkitConfig) -> Result<Vec<u8>, String> {
        self.rootkit_builder.build(config)
    }
}
